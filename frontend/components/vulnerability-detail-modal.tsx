"use client";

import { useEffect, useState } from "react";
import { createClient } from "@/lib/supabase/client";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import {
  FileText,
  User,
  Calendar,
  CheckCircle,
  XCircle,
  Clock,
  AlertCircle,
  ExternalLink,
  Building2,
} from "lucide-react";
import { ScrollArea } from "@/components/ui/scroll-area";

interface VulnerabilityDetailModalProps {
  vulnerabilityId: string | null;
  isOpen: boolean;
  onClose: () => void;
}

export default function VulnerabilityDetailModal({
  vulnerabilityId,
  isOpen,
  onClose,
}: VulnerabilityDetailModalProps) {
  const [loading, setLoading] = useState(false);
  const [vulnerability, setVulnerability] = useState<any>(null);
  const supabase = createClient();

  useEffect(() => {
    if (isOpen && vulnerabilityId) {
      loadVulnerabilityDetails();
    }
  }, [isOpen, vulnerabilityId]);

  const loadVulnerabilityDetails = async () => {
    if (!vulnerabilityId) return;

    try {
      setLoading(true);

      // Fetch vulnerability with organization
      const { data: vulnData, error: vulnError } = await supabase
        .from("vulnerabilities")
        .select(`
          *,
          organizations!inner (
            name,
            contact_email
          )
        `)
        .eq("id", vulnerabilityId)
        .single();

      if (vulnError) {
        console.error("Error loading vulnerability details:", vulnError);
        return;
      }

      // Collect user IDs
      const userIds = new Set<string>();
      if (vulnData.submitted_by) userIds.add(vulnData.submitted_by);
      if (vulnData.approved_by) userIds.add(vulnData.approved_by);
      if (vulnData.assigned_to_client) userIds.add(vulnData.assigned_to_client);

      // Fetch verifications
      const { data: verificationsData } = await supabase
        .from("verifications")
        .select("*")
        .eq("vulnerability_id", vulnerabilityId);

      // Add verification user IDs
      verificationsData?.forEach(verification => {
        if (verification.assigned_to_security_team) {
          userIds.add(verification.assigned_to_security_team);
        }
      });

      // Fetch all profiles
      const { data: profilesData } = await supabase
        .from("profiles")
        .select("id, full_name")
        .in("id", Array.from(userIds));

      // Create profile map
      const profileMap = new Map();
      profilesData?.forEach(profile => {
        profileMap.set(profile.id, profile);
      });

      // Enrich verifications with profiles
      const enrichedVerifications = verificationsData?.map(verification => ({
        ...verification,
        assigned_to_security_team_profile: verification.assigned_to_security_team && profileMap.get(verification.assigned_to_security_team)
          ? [profileMap.get(verification.assigned_to_security_team)]
          : undefined,
      }));

      // Build enriched vulnerability object
      const enrichedVulnerability = {
        ...vulnData,
        submitted_by_profile: vulnData.submitted_by && profileMap.get(vulnData.submitted_by)
          ? [profileMap.get(vulnData.submitted_by)]
          : [],
        approved_by_profile: vulnData.approved_by && profileMap.get(vulnData.approved_by)
          ? [profileMap.get(vulnData.approved_by)]
          : [],
        assigned_to_client_profile: vulnData.assigned_to_client && profileMap.get(vulnData.assigned_to_client)
          ? [profileMap.get(vulnData.assigned_to_client)]
          : [],
        verifications: enrichedVerifications || [],
      };

      setVulnerability(enrichedVulnerability);
    } catch (error) {
      console.error("Error:", error);
    } finally {
      setLoading(false);
    }
  };

  const getSeverityColor = (severity: string) => {
    const colors: { [key: string]: string } = {
      Critical: "bg-red-600 text-white",
      High: "bg-orange-600 text-white",
      Medium: "bg-yellow-600 text-white",
      Low: "bg-blue-600 text-white",
      Informational: "bg-gray-600 text-white",
    };
    return colors[severity] || "bg-gray-600 text-white";
  };

  const getStatusColor = (status: string) => {
    const colors: { [key: string]: string } = {
      pending: "bg-yellow-100 text-yellow-800",
      approved: "bg-green-100 text-green-800",
      rejected: "bg-red-100 text-red-800",
      open: "bg-blue-100 text-blue-800",
      reopened: "bg-orange-100 text-orange-800",
      closed: "bg-gray-100 text-gray-800",
      verified: "bg-green-100 text-green-800",
      assigned: "bg-purple-100 text-purple-800",
    };
    return colors[status] || "bg-gray-100 text-gray-800";
  };

  if (!isOpen) return null;

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <FileText className="h-5 w-5 text-purple-600" />
            Vulnerability Details
          </DialogTitle>
          <DialogDescription>
            Complete timeline and information about this vulnerability
          </DialogDescription>
        </DialogHeader>

        {loading ? (
          <div className="flex items-center justify-center py-12">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
          </div>
        ) : vulnerability ? (
          <ScrollArea className="max-h-[70vh] pr-4">
            <div className="space-y-6">
              {/* Header */}
              <div className="border-b pb-4">
                <h3 className="text-xl font-bold text-gray-900 mb-2">
                  {vulnerability.title}
                </h3>
                <div className="flex gap-2">
                  <Badge className={getSeverityColor(vulnerability.severity)}>
                    {vulnerability.severity}
                  </Badge>
                  <Badge className={getStatusColor(vulnerability.status)}>
                    {vulnerability.status.charAt(0).toUpperCase() +
                      vulnerability.status.slice(1)}
                  </Badge>
                  {vulnerability.service_type && (
                    <Badge variant="outline">{vulnerability.service_type}</Badge>
                  )}
                </div>
              </div>

              {/* Organization Info */}
              <Card>
                <CardHeader>
                  <CardTitle className="text-sm flex items-center gap-2">
                    <Building2 className="h-4 w-4" />
                    Organization
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <p className="font-semibold">{vulnerability.organizations.name}</p>
                  {vulnerability.organizations.contact_email && (
                    <p className="text-sm text-gray-600">
                      {vulnerability.organizations.contact_email}
                    </p>
                  )}
                </CardContent>
              </Card>

              {/* Vulnerability Details */}
              <Card>
                <CardHeader>
                  <CardTitle className="text-sm">Technical Details</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <p className="text-xs font-semibold text-gray-600 mb-1">
                      Description
                    </p>
                    <div className="bg-gray-50 p-3 rounded border text-sm">
                      {vulnerability.description}
                    </div>
                  </div>

                  {vulnerability.poc && (
                    <div>
                      <p className="text-xs font-semibold text-gray-600 mb-1">
                        Proof of Concept
                      </p>
                      <a
                        href={vulnerability.poc}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-blue-600 hover:text-blue-800 text-sm flex items-center gap-1"
                      >
                        {vulnerability.poc}
                        <ExternalLink className="h-3 w-3" />
                      </a>
                    </div>
                  )}

                  {vulnerability.instances && (
                    <div>
                      <p className="text-xs font-semibold text-gray-600 mb-1">
                        Instances
                      </p>
                      <pre className="bg-purple-50 p-3 rounded border text-xs">
                        {vulnerability.instances}
                      </pre>
                    </div>
                  )}

                  <div className="grid grid-cols-2 gap-4">
                    {vulnerability.cvss_score && (
                      <div>
                        <p className="text-xs font-semibold text-gray-600 mb-1">
                          CVSS Score
                        </p>
                        <p className="text-lg font-bold text-gray-900">
                          {vulnerability.cvss_score}
                        </p>
                      </div>
                    )}
                    {vulnerability.cwe_id && (
                      <div>
                        <p className="text-xs font-semibold text-gray-600 mb-1">
                          CWE ID
                        </p>
                        <p className="text-sm font-semibold">{vulnerability.cwe_id}</p>
                      </div>
                    )}
                  </div>

                  {vulnerability.affected_systems && (
                    <div>
                      <p className="text-xs font-semibold text-gray-600 mb-1">
                        Affected Systems
                      </p>
                      <p className="text-sm">{vulnerability.affected_systems}</p>
                    </div>
                  )}

                  {vulnerability.remediation && (
                    <div>
                      <p className="text-xs font-semibold text-gray-600 mb-1">
                        Remediation
                      </p>
                      <div className="bg-green-50 p-3 rounded border text-sm">
                        {vulnerability.remediation}
                      </div>
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Timeline */}
              <Card>
                <CardHeader>
                  <CardTitle className="text-sm flex items-center gap-2">
                    <Clock className="h-4 w-4" />
                    Timeline
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  {/* Submission */}
                  <div className="flex gap-3">
                    <div className="flex flex-col items-center">
                      <div className="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                        <FileText className="h-4 w-4 text-blue-600" />
                      </div>
                      <div className="h-full w-0.5 bg-gray-300 mt-2"></div>
                    </div>
                    <div className="flex-1 pb-4">
                      <p className="font-semibold text-sm">Vulnerability Submitted</p>
                      <p className="text-xs text-gray-600">
                        By{" "}
                        {vulnerability.submitted_by_profile?.[0]?.full_name ||
                          "Unknown"}{" "}
                        on {new Date(vulnerability.created_at).toLocaleDateString()}
                      </p>
                      {vulnerability.security_team_comments && (
                        <div className="mt-2 bg-yellow-50 p-2 rounded border border-yellow-200 text-xs">
                          <p className="font-semibold text-yellow-900">
                            Security Team Comments:
                          </p>
                          <p className="text-gray-700">
                            {vulnerability.security_team_comments}
                          </p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Admin Review */}
                  {vulnerability.approved_at && (
                    <div className="flex gap-3">
                      <div className="flex flex-col items-center">
                        <div
                          className={`h-8 w-8 rounded-full flex items-center justify-center ${
                            vulnerability.status === "approved"
                              ? "bg-green-100"
                              : "bg-red-100"
                          }`}
                        >
                          {vulnerability.status === "approved" ? (
                            <CheckCircle className="h-4 w-4 text-green-600" />
                          ) : (
                            <XCircle className="h-4 w-4 text-red-600" />
                          )}
                        </div>
                        {vulnerability.assigned_to_client && (
                          <div className="h-full w-0.5 bg-gray-300 mt-2"></div>
                        )}
                      </div>
                      <div className="flex-1 pb-4">
                        <p className="font-semibold text-sm">
                          Admin {vulnerability.status === "approved" ? "Approved" : "Rejected"}
                        </p>
                        <p className="text-xs text-gray-600">
                          By{" "}
                          {vulnerability.approved_by_profile?.[0]?.full_name ||
                            "Unknown"}{" "}
                          on {new Date(vulnerability.approved_at).toLocaleDateString()}
                        </p>
                        {vulnerability.admin_comments && (
                          <div className="mt-2 bg-indigo-50 p-2 rounded border border-indigo-200 text-xs">
                            <p className="font-semibold text-indigo-900">
                              Admin Comments:
                            </p>
                            <p className="text-gray-700">
                              {vulnerability.admin_comments}
                            </p>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Client Assignment */}
                  {vulnerability.assigned_to_client && (
                    <div className="flex gap-3">
                      <div className="flex flex-col items-center">
                        <div className="h-8 w-8 rounded-full bg-purple-100 flex items-center justify-center">
                          <User className="h-4 w-4 text-purple-600" />
                        </div>
                        {vulnerability.verifications &&
                          vulnerability.verifications.length > 0 && (
                            <div className="h-full w-0.5 bg-gray-300 mt-2"></div>
                          )}
                      </div>
                      <div className="flex-1 pb-4">
                        <p className="font-semibold text-sm">
                          Assigned to Client
                        </p>
                        <p className="text-xs text-gray-600">
                          {vulnerability.assigned_to_client_profile?.[0]
                            ?.full_name || "Unknown"}
                        </p>
                        {vulnerability.client_status && (
                          <Badge
                            className={`mt-2 ${getStatusColor(
                              vulnerability.client_status
                            )}`}
                            variant="outline"
                          >
                            {vulnerability.client_status
                              .charAt(0)
                              .toUpperCase() +
                              vulnerability.client_status.slice(1)}
                          </Badge>
                        )}
                        {vulnerability.client_updated_at && (
                          <p className="text-xs text-gray-600 mt-1">
                            Last updated:{" "}
                            {new Date(
                              vulnerability.client_updated_at
                            ).toLocaleDateString()}
                          </p>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Verifications */}
                  {vulnerability.verifications &&
                    vulnerability.verifications.map(
                      (verification: any, idx: number) => (
                        <div key={verification.id} className="flex gap-3">
                          <div className="flex flex-col items-center">
                            <div
                              className={`h-8 w-8 rounded-full flex items-center justify-center ${
                                verification.verification_status === "verified"
                                  ? "bg-green-100"
                                  : verification.verification_status === "rejected"
                                  ? "bg-red-100"
                                  : "bg-yellow-100"
                              }`}
                            >
                              {verification.verification_status ===
                              "verified" ? (
                                <CheckCircle className="h-4 w-4 text-green-600" />
                              ) : verification.verification_status ===
                                "rejected" ? (
                                <XCircle className="h-4 w-4 text-red-600" />
                              ) : (
                                <AlertCircle className="h-4 w-4 text-yellow-600" />
                              )}
                            </div>
                          </div>
                          <div className="flex-1">
                            <p className="font-semibold text-sm">
                              Verification Request #{idx + 1}
                            </p>
                            <p className="text-xs text-gray-600">
                              Submitted on{" "}
                              {new Date(
                                verification.submitted_at
                              ).toLocaleDateString()}
                            </p>
                            {verification.assigned_to_security_team_profile?.[0] && (
                              <p className="text-xs text-gray-600">
                                Assigned to:{" "}
                                {
                                  verification
                                    .assigned_to_security_team_profile[0]
                                    .full_name
                                }
                              </p>
                            )}
                            <Badge
                              className={`mt-1 ${getStatusColor(
                                verification.verification_status
                              )}`}
                              variant="outline"
                            >
                              {verification.verification_status
                                .charAt(0)
                                .toUpperCase() +
                                verification.verification_status.slice(1)}
                            </Badge>
                            {verification.verified_at && (
                              <p className="text-xs text-gray-600 mt-1">
                                Completed on:{" "}
                                {new Date(
                                  verification.verified_at
                                ).toLocaleDateString()}
                              </p>
                            )}
                            {verification.client_comments && (
                              <div className="mt-2 bg-blue-50 p-2 rounded border border-blue-200 text-xs">
                                <p className="font-semibold text-blue-900">
                                  Client Comments:
                                </p>
                                <p className="text-gray-700">
                                  {verification.client_comments}
                                </p>
                              </div>
                            )}
                            {verification.security_team_comments && (
                              <div className="mt-2 bg-yellow-50 p-2 rounded border border-yellow-200 text-xs">
                                <p className="font-semibold text-yellow-900">
                                  Security Team Comments:
                                </p>
                                <p className="text-gray-700">
                                  {verification.security_team_comments}
                                </p>
                              </div>
                            )}
                          </div>
                        </div>
                      )
                    )}
                </CardContent>
              </Card>
            </div>
          </ScrollArea>
        ) : (
          <div className="text-center py-12">
            <AlertCircle className="h-12 w-12 text-gray-400 mx-auto mb-4" />
            <p className="text-gray-500">Failed to load vulnerability details</p>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
